# AI Chatbot App — iOS PRD

> **文档持续更新中**

---

## V1.0 文本聊天与会话管理

### 1.1 目标

为用户提供一个轻量、离线可用的 AI 聊天工具，满足快速问答与思路记录需求。核心能力包括：

- 发送消息给 Qwen 大模型
- 清晰显示 AI 回复（支持 Markdown 格式）
- 本地保存所有聊天历史，保护隐私
- 支持创建新会话或回顾历史对话

### 1.2 核心功能

1. **聊天气泡界面**
   - 用户消息右对齐，AI 回复左对齐
   - 输入时自动聚焦并确保聊天区域可见

2. **底部输入框 + 发送按钮**
   - 支持回车发送
   - 防空提交
   - ≤1000 字限制

3. **会话列表页**
   - 顶部提供“+ 新对话”按钮，点击后进入全新聊天界面（上下文清空）
   - 按创建时间倒序排列，显示最后一条消息预览 + 时间
   - 点击任一会话可进入并继续对话（保留完整历史）

4. **AI 交互**
   - 调用 Qwen 免费 API（[通义千问 API 文档](https://help.aliyun.com/zh/model-studio/qwen-api-reference)）
   - AI 回复时显示“加载中”状态，避免用户重复点击

### 1.3 非目标（MVP 中不做）

- 用户登录（所以 Prototype 中不支持 "Profile" 组件按钮）
- 云端同步
- 支持语音/图片
- 额外多技能标签（如“分析”、“导出”等）
- 实时流式回复（Qwen 免费版不支持 Streaming，所以 Prototype 中不支持 "Stop generating..." 等组件按钮）

### 1.4 技术栈

- **前端框架**：React Native (Expo)
- **网络请求**：前端使用原生 `fetch` 调用自建 Node.js/Express 后端，由后端统一代理 Qwen API（兼容模式）
- **UI 组件库**：React Native Paper
- **本地存储（前端）**：SQLite（via expo-sqlite），用于存储会话、消息与本地图片 URI
- **状态管理**：React Context + useState（轻量级全局状态共享）
- **后端存储**：本地 JSON 文件（`session_store.json`），用于持久化会话历史上下文

### 1.5 已实现范围回顾（当前 iOS 原型）

结合当前 `ai-chatbot-app` 代码，V1.0 iOS 原型已经实现的“最小可用”功能包括：

1. **基础聊天**
   - 通过后端 Qwen 代理（OpenAI 兼容协议）发送文本消息给通义千问大模型
   - 支持多轮对话，后端通过本地 JSON 文件维护会话上下文（`sessionId -> messages`）
   - 前端采用聊天气泡 UI，用户消息右对齐、AI 消息左对齐，支持加载中状态

2. **本地会话与消息管理（隐私优先）**
   - 使用 SQLite（`expo-sqlite`）在本地存储会话列表与消息记录
   - 会话列表按时间倒序展示，并支持按时间分组（“今天” / “最近 7 天”）
   - 支持新建会话、删除会话、重命名会话

3. **侧边栏会话导航**
   - iOS App 使用左侧抽屉式侧边栏展示历史会话列表
   - 任意时刻可从顶部汉堡按钮打开侧边栏，快速切换当前会话

4. **消息多版本与编辑重发（超出最初 MVP 的增强版本）**
   - 对于同一轮对话，支持“多版提问 + 多版回答”：
     - 用户可以编辑历史提问并重新发送，逐步优化表达
     - AI 会生成多版回答，前端支持在多个回复版本之间切换
   - 提供对整轮对话的删除能力（提问 + 所有版本回答一并删除）

5. **自动生成会话标题**
   - 后端提供 `/api/chat/title` 接口，基于当前会话的若干轮对话自动生成简短标题
   - 前端在首次对话后自动为会话生成标题，用于侧边栏列表展示

### 1.6 已实现且超出最初 V1.0 设想的能力

与原始 V1.0 PRD 相比，当前原型已经额外实现了以下功能：

1. **多版本对话管理**
   - 用户可以针对同一问题多次编辑提问，逐步优化表达
   - AI 回复与用户提问按“对话轮”聚合展示，并支持同步切换不同版本

2. **整轮删除 & 错误重试**
   - 支持针对一轮对话（提问+回复）整体删除
   - 网络错误时，错误消息不入库，仅在 UI 中短暂展示，并提供“重试发送”的交互

3. **更完善的会话列表 UX**
   - 会话卡片支持标题、AI 回复预览和时间标签
   - 支持长按/菜单重命名、删除，并在被删除会话时自动回退到主聊天页

这些能力为后续引入“图片消息”和“图片管理”打下了良好的架构基础（数据库层 / 会话层 / UI 层均已模块化）。

### 1.7 界面原型

- **低保真原型图**：已绘制于 Figma  
  [https://www.figma.com/design/MhXg9S3oypEfiDxPfuk7Dg/ai-chat-mini-wireframe?node-id=0-1&t=MFAfSGdyKD1Dtuti-1](https://www.figma.com/design/MhXg9S3oypEfiDxPfuk7Dg/ai-chat-mini-wireframe?node-id=0-1&t=MFAfSGdyKD1Dtuti-1)
- **包含内容**：
  - 会话列表页：顶部“+ 新对话”按钮 + 按时间倒序排列的会话卡片
  - 聊天主界面：左右对齐气泡、底部输入框、加载状态示意

---

## V2.0 图片理解与管理

V2.0 的目标是在现有文本聊天基础上，引入轻量级但实用的“图片理解 + 管理”能力，并明确控制 MVP 范围，避免过度工程。

### 2.1 新增能力概述

1. **上传图片并识别（核心）**
   - 用户可以从相册选择图片（后续若有需要可扩展拍照入口）
   - 前端将图片发送至后端，由后端调用 Qwen-VL（多模态模型）进行解析

2. **聊天中显示缩略图**
   - 聊天记录中的“带图消息”在用户消息上方的图片区域展示，支持多图横向滑动
   - 支持点击任一缩略图查看大图预览

3. **当前会话图片管理页**
   - 在聊天页顶部增加一个“图片管理”入口（如相机/相册图标）
   - 进入后展示当前会话下所有已上传的图片（网格布局）
   - 每张图片提供：
     - 预览（点开大图）
     - “再次应用/再次发送”按钮（将图片重新作为新消息发给 AI）
     - 删除（从本地移除图片及其元数据）

4. **再次应用逻辑**
   - 用户在图片管理页点击“再次发送”后：
     - 前端构造一条新的用户消息，携带该图片作为上下文（可选附加文本问题）
     - 后端调用 Qwen-VL 多模态接口，而非纯文本接口
   - 聊天记录中会新增一轮带图对话，并可像文本消息一样参与后续上下文

### 2.2 MVP 范围界定

#### 核心范围（Inner Scoop）

V2.0 的 MVP 核心功能聚焦于“当前会话内的图片理解与管理”，包含以下三项：

1. **上传图片并识别**
   - 用户可以从相册选择图片（如需拍照可在后续版本扩展）
   - 前端将图片发送至后端，由后端调用 Qwen-VL（多模态模型）进行解析

2. **聊天中显示缩略图**
   - 聊天记录中的“带图消息”在用户消息上方的图片区域展示，支持多图横向滑动
   - 支持点击任一缩略图查看大图预览

3. **当前会话图片管理页**
   - 在聊天页顶部增加一个“图片管理”入口（如相机/相册图标）
   - 进入后展示当前会话下所有已上传的图片（网格布局）
   - 每张图片支持：预览、再次发送、删除

#### 超出范围（Outer Scoop / 暂不做）

以下功能不在 V2.0 MVP 范围内，但可作为未来迭代的候选方向：

1. **跨会话图片复用**
   - 需要引入全局图片库、跨会话引用等机制，复杂度较高，超出 MVP 必要范围

2. **云端图片存储**
   - 暂不做：现阶段本地 SQLite + 文件系统已经足够，继续沿用“离线优先、本地优先”的设计，降低后端与安全复杂度

### 2.3 技术方案概览（与现有架构的衔接）

1. **数据存储层（SQLite + 本地文件系统）**
   - 新增 `images` 表，存储图片元数据：
     - 字段：`id`, `session_id`, `uri`, `created_at`
     - 约束：`FOREIGN KEY(session_id) REFERENCES sessions(id) ON DELETE CASCADE`
   - 图片文件本身存储在移动端本地文件系统（如 Expo FileSystem 的 `documentDirectory/images/`），数据库中仅保存本地 URI

2. **前端能力扩展**
   - 新增依赖：
     - `expo-image-picker`：用于从相册选择图片（保留扩展相机能力的接口）
     - `expo-file-system`：用于将选中的图片复制到应用私有目录并读取为 base64
   - 在 `Chatbot` 主聊天页面：
     - 底部输入区新增图片按钮，支持用户多选图片并发送带图消息
     - 聊天列表中的消息在文本气泡上方展示图片区域，可横向滑动查看多张缩略图
   - 新增页面 `ImageGalleryScreen`：
     - 通过路由参数接收 `session_id`
     - 查询并展示当前会话下的所有图片（网格 + 预览 + 再次发送 + 删除）

3. **后端 Qwen 代理扩展（多模态支持）**
   - 在现有 `/api/chat/completions` 接口基础上，扩展支持图片：
     - 请求体新增 `imageBase64` 字段（由前端在调用前从本地 URI 读取并编码），并兼容 `imagesBase64[]` 批量传图
     - 当存在任意图片字段时：
       - 使用 Qwen-VL 模型（如 `qwen3-vl-plus`），按照官方多模态接口格式发送“多图 + 文本”消息
       - 将模型返回结果与现有文本对话流程对齐（统一包装成 `reply`，可选写入会话历史）
     - 当 `imageBase64` 不存在时，保留原有纯文本逻辑不变

4. **“再次应用”交互与 UX 规范**
   - 在聊天记录中的图片区域支持点击查看大图、长按触发“重新分析此图”等操作
   - 在图片管理页为每张图片提供明显的“再次发送”按钮（例如 🔁 图标）
   - 当用户触发“再次应用”时：
     - 默认提示用户输入一个新的问题（可选），再与图片一并发送给模型
     - 新生成的回答与对应图片一同显示在聊天记录中，保持对话的一致性与可追溯性

### 2.4 实际实现补充说明（已交付增强）

1. **多图上传与联合解析**
   - 前端一次可选择多张图片（支持横向滑动预览），后端通过 `imagesBase64[]` 将多张图片同批发送给 `qwen3-vl-plus`，模型可以在单轮对话中联合理解多图

2. **一致的图片预览体验**
   - 聊天界面的图片区域与 `ImageGalleryScreen` 的网格 + Modal 预览体验保持一致，确保缩略图、全屏预览、再次发送的交互路径统一

3. **级联删除图片资产**
   - 删除会话时，SQLite `images` 表通过 `ON DELETE CASCADE` 自动清理关联记录，并触发本地文件删除，避免遗留隐私数据

### 2.5 可靠性增强：离线队列与自动重试（已实现）

#### 问题背景

- 典型使用场景：销售或一线人员在外出环境下使用（地铁、电梯、弱网环境），网络并不稳定
- 当前行为：当网络中断时，请求会失败并提示“无法连接后端服务”，但该轮消息只以错误气泡形式短暂展示，缺少系统级的“待发送队列”

#### 目标

- 消息在弱网 / 间歇性断网场景下**不丢失**
- 网络恢复后能够**自动补发**之前“已写好但未发出”的消息
- 用户可以清楚看到哪些消息仍在“待发送”，并能手动重试

#### 方案概览

1. **数据库扩展**
   - 在前端 SQLite 的 `messages` 表中新增状态字段：
     - `status`: `'sending' | 'queued' | 'failed' | 'sent'`
     - `retry_count`: 整数，用于控制自动重试次数上限（如 3 次）

2. **发送流程调整**
   - 用户点击发送后，先在本地插入一条用户消息：`status = 'sending'`
   - 如果调用后端失败且判断为**网络错误**（无法连接 / 超时）：
     - 将该消息标记为 `status = 'queued'`（待发送队列），UI 显示“待发送（网络恢复后将自动重试）”
   - 如果是**业务错误**（如 4xx 参数错误 / 鉴权失败）：
     - 标记为 `status = 'failed'`，仅允许手动重试，避免无限自动重试

3. **网络监听与自动重试**
   - 使用 React Native / Expo 提供的网络状态监听（如 `NetInfo`）：
     - 当检测到从 offline → online 时，触发一次 `retryQueuedMessages()`：
       - 查询 SQLite：`status = 'queued'` 的消息，按时间顺序逐条重试
       - 成功则标记为 `status = 'sent'`，失败则增加 `retry_count`
      - 超过最大重试次数的消息标记为 `status = 'failed'`，并在 UI 中提示“发送失败，请手动重试”

4. **UI 表现**
   - 在 `MessageBubble` 中，根据 `status` 显示不同状态标记：
     - `sending`: 小型“发送中…”指示
     - `queued`: “待发送（网络恢复后将自动重试）”标签
     - `failed`: “发送失败，请检查网络后重试”标签 + “重试”按钮

#### 价值

- 在弱网环境下显著降低“误以为消息已发出、实际丢失”的风险
- 对销售类使用场景尤为关键：保障关键对话不会因为瞬时网络抖动而丢失
- 整体符合“本地优先 + 可恢复”的产品定位，为未来可能的“多设备同步”打下基础（届时可将待发送队列扩展到云端）

### 2.6 V2.0 已完成 / 超出范围能力汇总

结合当前代码实现，以下 V2.0 能力已经完成或超出最初 PRD 设想：

1. **多图多模态消息（超出原始单图设想）**
   - 已支持在一轮对话中同时发送多张图片，前端以横向滑动缩略图 + 大图预览呈现，后端通过 `imagesBase64[]` 将多图一次性发送给 `qwen3-vl-plus` 联合解析

2. **图片管理增强**
   - 当前会话图片管理页已实现：网格展示、预览、再次发送、删除本地文件和数据库记录，并在删除会话时自动级联清理所有关联图片资产

3. **会话与消息结构优化**
   - 前端支持“多版提问 + 多版回答”的对话轮结构，允许在同一轮中编辑提问并生成多个 AI 回复版本，并在 UI 中同步切换版本
   - 删除一轮消息时，会同时删除该轮下所有版本的提问与回答，保持会话历史干净可控

4. **后端上下文记忆持久化**
   - 后端通过本地文件 `session_store.json` 维护每个 `sessionId` 的最近若干条历史消息，用于统一控制发送给 Qwen 的上下文长度（而不仅仅是进程内临时内存），服务重启后仍能保留最近历史

5. **模型调用策略与思考模式预留**
   - 已实现“纯文本 → `qwen-plus-2025-07-28`，带图 → `qwen3-vl-plus`”的自动模型选择策略
   - 通过环境变量 `QWEN_ENABLE_THINKING` / `QWEN_THINKING_BUDGET` 预留了思考模式参数（`enable_thinking`、`thinking_budget`），方便未来在不改前端的前提下开启高级推理能力

6. **前端性能与体验优化**
   - 对大量历史消息的渲染增加了“只显示最近 N 轮对话 + 顶部加载更多历史对话”的机制，避免一次性渲染上百轮气泡导致卡顿，同时保留完整历史可逐步展开
   - 错误提示统一为中文、按网络错误 / 后端错误 / 鉴权错误等类型给出可操作建议，提升可解释性和排错效率

7. **离线队列与自动重试（已实现）**
   - 已实现消息状态管理（`sending` / `queued` / `failed` / `sent`）
   - 网络恢复后自动重试待发送消息
   - UI 中清晰显示消息发送状态，支持手动重试失败消息

8. **数据管理增强**
   - 在 Profile 页面新增“清除所有数据”按钮，支持一键删除所有会话和图片，满足 GDPR/CCPA 类似需求
